Array.prototype.equals=function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var t=0,n=this.length;t<n;t++)if(this[t]instanceof Array&&e[t]instanceof Array){if(!this[t].equals(e[t]))return!1}else if(this[t]!=e[t])return!1;return!0},Object.defineProperty(Array.prototype,"equals",{enumerable:!1}),Set.prototype.AddRange=function(e){if(null!=e)if(Array.isArray(e))for(const t of e)null==t||this.has(t)?console.log("Set.prototype.AddRange() :: Cannot add, value is null."):this.add(t);else this.has(e)||this.add(e)},Set.prototype.Add=function(e){null==e||this.has(e)?console.log("Set.prototype.Add() :: Cannot add, value is null."):this.add(e)},Set.prototype.Invoke=function(e,t,n,i,o,a,l,s,c,r,d,u,v,f,p,h,g,m,b,D,S,y,q,E,M,w){if(this.size>0)for(const k of this)k(e,t,n,i,o,a,l,s,c,r,d,u,v,f,p,h,g,m,b,D,S,y,q,E,M,w)},Set.prototype.Merge=function(e){if(null==this&&null==e)return null;var t=new Set;if(null!=this&&this.size>0)for(const e of this)t.add(e);if(null!=e&&e.size>0)for(const n of e)t.add(n);return t};class SetExt extends Set{static Merge(e,t){if(null==e&&null==t)return null;var n=new Set;if(null!=e&&e.size>0)for(const t of e)n.add(t);if(null!=t&&t.size>0)for(const e of t)n.add(e);return n}static AddRange(e,t){if(null!=t)if(Array.isArray(t))for(const n of t)e.add(n);else e.add(t);return e}}function localStoreObj(e,t){var n=JSON.stringify(t);localStorage.setItem(e,n)}function localReadObj(e){let t=localStorage.getItem(e);if(null!=t)return null==t?null:JSON.parse(t)}function localHasObj(e){let t=localStorage.getItem(e);return null!=t&&null!=t}String.format=function(){for(var e=arguments[0],t=0;t<arguments.length-1;t+=1){var n=new RegExp("\\{"+t+"\\}","gm");e=e.replace(n,arguments[t+1])}return e};var EventWindowResize=new Set;function CallEventWindowResize(e){EventWindowResize.Invoke(e)}$(window).resize(CallEventWindowResize);var EventWindowScroll=new Set;function CallEventWindowScroll(e){EventWindowScroll.Invoke(e)}$(window).scroll(CallEventWindowScroll);var EventReady=new Set;function CallEventReady(e){EventReady.Invoke(e)}$(document).ready(CallEventReady);var EventMouseMove=new Set;function CallEventMouseMove(e){EventMouseMove.Invoke(e)}$(document).mousemove(CallEventMouseMove),EventMouseMove.add(TrackMouse);var mouseX=0,mouseY=0;function TrackMouse(e){mouseX=e.pageX,mouseY=e.pageY}var events={};function invokeEvent(e){events[e].Invoke()}function onEvent(e,t){events[e].add(t)}function removeFromEvent(e,t){events[e].delete(t)}function createEvent(e){events[e]=new Set}function deleteEvent(e){try{null!=events[e]&&delete events[e]}catch{}}class ElementBuilder{constructor(e,t,n,i,o,a,l,s){this.type=e,this.id=null!=t?t:null,this.classes=null!=n?n:null,this.attrs=null!=i?i:null,this.text=null!=o?o:null,this.isHtml=null!=a?a:null,this.events=null!=l?l:null,this.css=s}static AddValue(e,t){return null==e?e=t:Array.isArray(e)?Array.isArray(t)?e.concat(t):e.push(t):(e=[e],ElementBuilder.AddValue(e,t)),e}}function createElement(e,t,n,i,o,a,l,s){return new ElementBuilder(e,t,n,i,o,a,null!=l?{key:"click",value:l}:null,s).Create()}ElementBuilder.prototype.Id=function(e){this.id=e},ElementBuilder.prototype.Classes=function(e){this.classes=ElementBuilder.AddValue(this.classes,e)},ElementBuilder.prototype.Attrs=function(e,t){arguments.length>1&&(e={key:e,value:t}),this.attrs=ElementBuilder.AddValue(this.attrs,e)},ElementBuilder.prototype.Css=function(e,t){arguments.length>1&&(e={key:e,value:t}),this.css=ElementBuilder.AddValue(this.css,e)},ElementBuilder.prototype.Text=function(e){this.isHtml=!1,this.text=e},ElementBuilder.prototype.Html=function(e){this.text=e,this.isHtml=!0},ElementBuilder.prototype.AddEvent=function(e,t){null==this.events&&(this.events={}),null==this.events[e]&&(this.events[e]=[]),this.events[e].push(t)},ElementBuilder.prototype.Click=function(e){this.AddEvent("click",e)},ElementBuilder.prototype.Create=function(){var e=document.createElement(this.type);if(e=$(e),null!=this.id&&e.attr("id",this.id),null!=this.classes)if(Array.isArray(this.classes))for(var t=0;t<this.classes.length;t++)e.addClass(this.classes[t]);else e.addClass(this.classes);if(null!=this.attrs)if(Array.isArray(this.attrs))for(t=0;t<this.attrs.length;t++)addAttr(e,this.attrs[t]);else addAttr(e,this.attrs);if(null!=this.css)if(Array.isArray(this.css))for(t=0;t<this.css.length;t++)e.css(this.css[t].key,this.css[t].value);else e.css(this.css.key,this.css.value);if(null!=this.text&&this.text.length>0&&(null==this.isHtml||0==this.isHtml?e.text(this.text):e.html(this.text)),null!=this.events)for(let t in this.events)for(let n=0;n<this.events[t].length;n++)$(e).on(t,this.events[t][n]);return e},$(".remove-me").remove();var classTableNoBorders="table-borderless";function clickToggleBorder(){var e=$(this).attr("border-id"),t=null==e||0==e.length?$(this).parent().find("table"):$("[border-id="+e+"]").find("table"),n=t.hasClass(classTableNoBorders);console.log("has borders "+n),n?t.removeClass(classTableNoBorders):t.addClass(classTableNoBorders)}function clickHideContent(){var e=$(this).attr("hide-id"),t=null==e||0==e.length?$(this).next():$("[hide-id="+e+"]:not(button)"),n=$(t).is(":visible");console.log("is visible "+n),n?(t.hide(),$(this).text("Show")):(t.show(),$(this).text("Hide"))}$("button[action=border-toggle]").click(clickToggleBorder),$("button[action=hide-content]").click(clickHideContent),$("main").hide();var navHtml='<nav id="nav_head" class="navbar navbar-light navbar-expand-md navigation-clean">\n    <div class="container"><a class="navbar-brand" href="/" target="_top">ESP Sense</a><button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navcol"><span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>\n        <div id="navcol" class="collapse navbar-collapse">\n            <ul class="navbar-nav ms-auto">\n                <li id="nav_cfg" class="nav-item"><a class="nav-link" href="/config.html" target="_top">Configuration</a></li>\n                <li id="nav_dbgCon" class="nav-item"><a class="nav-link" href="/console.html" target="_top">Debug Console</a></li>\n                <li id="nav_webupdate" class="nav-item"><a class="nav-link" href="/update.html" target="_top">Update Firmware</a></li>\n                <li id="nav_cfgmqtt" class="nav-item"><a class="nav-link" href="/mqtt/devices.html" target="_top">MQTT Devices</a></li>\n                <li id="nav_tools" class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown">Tools</a>\n                    <div class="dropdown-menu"><a id="nav_tools_json" class="dropdown-item" href="/tools/jsonass.html" target="_top">JSON Assistant</a><a id="nav_tools_fileEditor" class="dropdown-item" href="/tools/fileeditor.html" target="_top">File Editor</a><a id="nav_tools_templateGen" class="dropdown-item" href="/tools/templategen.html" target="_top">MQTT Template Generator</a></div>\n                </li>\n            </ul><button id="logout_but" class="btn btn-primary" type="button">Log out</button>\n        </div>\n        <div class="gradient"></div>\n    </div>\n</nav>',footerHtml='<footer>\n    <div class="gradient"></div>\n    <div class="container">\n        <div class="grid">\n            <h3 class="footing">ESP Sense</h3>\n            <div class="github"><a href="https://github.com/AddioElectronics/ESP-Sense"><i class="fa fa-github"></i></a></div><span class="version">Firmware Version x.x.x</span>\n        </div>\n    </div>\n</footer>';function setMainHeight(){let e=$("nav").height(),t=$("footer").height();$("html").height()}function Show(e){$(e).show(),$(e).removeClass("d-none")}function addAttr(e,t){function n(e,t){null!=t.value?$(e).attr(t.key,t.value):null!=t.key?$(e).attr(t.key,""):$(e).attr(t,"")}Array.isArray(e)?e.forEach((e=>n(e,t))):n(e,t)}function removeAttr(e,t){$.isArray(e)?e.forEach((e=>$(e).removeAttr(t))):$(e).removeAttr(t)}function disableObj(e,t){(e=$(e)).length>1?e.each((function(n){disableObj(e[n],t)})):(null!=e.attr("disabled")&&t&&addAttr(e,"keep-disabled"),addAttr(e,"disabled"),e.addClass("disabled"))}function enableObj(e,t){(e=$(e)).length>1?e.each((function(n){enableObj(e[n],t)})):(null!=e.attr("keep-disabled")&&1!=t||(removeAttr(e,"disabled"),e.removeClass("disabled")),removeAttr(e,"keep-disabled"))}function enableBlockingMsg(e,t,n,i,o){disableBlockingMsg();let a=e.split("\n"),l=createElement("div","blocking_message",["fs-1","text-break","font-monospace"]),s=createElement("div","blocking_overlay","fadein");$("body").append(l),$("body").append(s);for(let e=0;e<a.length;e++){let t=createElement(null==o?"h1":o);l.append(t),t.text(a[e])}let c=l.width()/$(document).width();l.css("left",50-100*c/2+"%"),null!=n&&l.css("color",n),t&&(l.css("z-index",9999),s.css("z-index",9999)),null!=i&&setTimeout(disableBlockingMsg,i)}function disableBlockingMsg(){$("#blocking_message").remove(),$("#blocking_overlay").remove()}function getPageName(){return window.location.pathname.split("/").pop()}function refreshPage(){window.location.reload(),window.location.href=window.location.href}function openInNewTab(e){window.open(e,"_blank").focus()}function capitalIndex(e,t){return e.charAt(t).toUpperCase()+e.slice(t+1)}function capitalFirst(e){return capitalIndex(e,0)}function sleep(e){return new Promise((t=>setTimeout(t,e)))}0==$(".navbar").length&&0!=$("html").length&&$("body").prepend(navHtml),0==$("footer").length&&0!=$("html").length&&$("body").append(footerHtml),EventWindowResize.add(setMainHeight),setMainHeight(),EventWindowScroll.add(setMainHeight),$.fn.isInViewport=function(e){var t={top:0,bottom:0,left:0,right:0};for(key in e)t[key]=e[key];let n=$(this).offset().top+t.bottom,i=n+$(this).outerHeight()+t.top,o=$(window).scrollTop(),a=o+$(window).height();return i>o&&n<a},$.fn.cssImportant=function(e,t){$(this).css(e,"");let n=e+":"+t+" !important";$(this).attr("style",(function(e,t){return(t||"")+n}))};const loadData=async(e,t)=>{try{const n=await fetch(e);let i=await n.json();t(i),console.log(i)}catch(e){console.warn(e)}};function getValueTypeClass(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),t}function syntaxHighlight(e){return"string"!=typeof e&&(e=JSON.stringify(e,null,2)),(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,(function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"}))}var notificationBox;function createNotificationBox(){let e=new ElementBuilder("aside","notifications").Create(),t=new ElementBuilder("div",null,"tab").Create(),n=new ElementBuilder("i",null,"fa fa-envelope-o").Create(),i=new ElementBuilder("div",null,"expandable").Create(),o=new ElementBuilder("div",null,"header").Create(),a=new ElementBuilder("span",null,null,null,"Notifications").Create(),l=new ElementBuilder("span",null,"counter",null,"0").Create(),s=new ElementBuilder("button",null,"btn",{key:"type",value:"button"},"Clear").Create(),c=new ElementBuilder("div",null,"note-list").Create();return t.append(n),o.append(a),o.append(l),o.append(s),i.append(o),i.append(c),e.append(t),e.append(i),$("body").append(e),s.click(clearNotifications),t.click(showNotifications),i.mouseleave(hideNotifications),e}function addNotification(e,t,n,i){let o=new ElementBuilder("notification",null,"notification").Create(),a=new ElementBuilder("div",null,"note-icon-con").Create(),l=new ElementBuilder("i",null,e).Create();a.append(l);let s=new ElementBuilder("div",null,"note-msg-con").Create(),c=new ElementBuilder("span",null,null,null,t).Create();s.append(c);let r=new ElementBuilder("div",null,"note-details-con").Create(),d=new ElementBuilder("i",null,"fa fa-remove").Create();r.append(d),o.append(a),o.append(s),o.append(r),null!=n&&o.cssImportant("color",n);let u=notificationBox.find(".note-list");u.append(o);let v=u.children().length.toString();return notificationBox.attr("value",v),notificationBox.find(".counter").text(v),o.on("click",(function(e){$(e.target).is("i.fa.fa-remove")||i()})),d.on("click",(function(){removeNotification(o)})),o}function removeNotification(e){(e=$(e)).addClass("remove");let t=(notificationBox.find(".note-list").children().length-1).toString();notificationBox.find(".counter").text(t),setTimeout((function(){e.remove(),notificationBox.attr("value",t)}),500)}function clearNotifications(){hideNotifications(),setTimeout((function(){notificationBox.find(".note-list").empty(),notificationBox.attr("value","0"),notificationBox.find(".counter").text("0")}),1e3)}function showNotifications(){0!=notificationBox.find(".note-list").children().length&&notificationBox.addClass("view")}function hideNotifications(){notificationBox.removeClass("view")}EventReady.add((function(){0==(notificationBox=$("aside#notifications")).length&&(notificationBox=createNotificationBox()),devMode&&(addNotification("fa fa-code","Update Available","green",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),addNotification("fa fa-code","Update Available","green",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),addNotification("fa fa-code","Update Available","gold",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),addNotification("fa fa-code","Update Available","gold",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),addNotification("fa fa-code","Update Available","green",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),addNotification("fa fa-code","Update Available","green",(function(){window.location.href="/update.html"})),addNotification("fa fa-code","Firmware and Website Version do not match","red",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})))}));var globalStatusJOBJ,rstBut,devMode=!0,keepTest=devMode&&!1,alwaysLoadPage=!1,websiteVersion=[0,2,0],githubReleasesUrl="https://github.com/AddioElectronics/ESP-Sense/releases",espVersion=[0,0,0],configMode=!1,mqttDevices={sensors:[],binarySensors:[],lights:[],buttons:[],switches:[]},devModeLabel='<span class="dev-mode">Developer Mode</span>',rstHtml='<button id="esp_reset_btn" class="btn" type="button" disabled>Reset ESP</button>';function espControllerInit(){console.log("espControllerInit"),0==$("#esp_reset_btn").length&&($("body").append(rstHtml),rstBut=$("#esp_reset_btn")),onEvent("auth",(function(){enableObj(rstBut)})),rstBut.on("click",espReset)}function espReset(){!updateInProgess&&Authenticator.authenticated&&(console.log("Sending Reset Request..."),$.ajax({type:"POST",url:"/reset",data:null,success:espIsResetting,error:function(e,t,n){console.log("Reset Failed")}}))}function espAlive(e,t){$.ajax({type:"GET",url:"/alive",data:null,success:e,error:t})}function refreshOnResponse(){setTimeout((function(){espAlive(refreshPage,(function(e,t,n){refreshOnResponse()}))}),5e3)}function espIsResetting(){console.log("Resetting ESP"),enableBlockingMsg("Resetting ESP...",!0),$("*").click((function(){return!1})),refreshOnResponse()}function getEspVersion(){console.log("getEspVersion()"),navWebUpdate=$("#nav_webupdate"),requestJsonData("/version",receivedVersion,(function(){console.log("GET version failed."),invokeEvent("version")}),null,5e3,!1)}function receivedVersion(e){devMode=!1,console.log("Received Version :"),console.log(e),espVersion=e.version,configMode=e.configMode,$("#global_status").length>0&&$("#global_status").append(syntaxHighlight(JSON.stringify(deviceStatusJOBJ,null,4)));var t=$(".version");t.text(t.text().replace("x.x.x",String.format("{0}.{1}.{2}",espVersion[0],espVersion[1],espVersion[2]))),invokeEvent("version");var n=getLatestVersion();-1==compareVersions(espVersion,n)&&addNotification("fa fa-code","Update Available","green",(function(){openInNewTab("https://github.com/AddioElectronics/ESP-Sense")})),0!=compareVersions(espVersion,websiteVersion)&&addNotification("fa fa-code","Firmware and Website Version do not match","yellow",(function(){openInNewTab(githubReleasesUrl)}))}function compareVersions(e,t){for(var n=0;n<3;n++){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return 0}function versionFromString(e){var t=[];try{for(var n=e.split("."),i=0;i<3;i++)t[i]=parseInt(n[i]);return t}catch{return null}}function getLatestVersion(){return espVersion}function addAlwaysLoadPage(){window.addEventListener("pageshow",(function(e){(e.persisted||void 0!==window.performance&&2===window.performance.navigation.type)&&window.location.reload()}))}createEvent("version"),createEvent("auth"),createEvent("reset"),createEvent("resetting"),createEvent("status"),createEvent("globalStatus"),createEvent("configMode"),keepTest||$(".test").remove(),alwaysLoadPage&&addAlwaysLoadPage(),EventReady.add((async function(){(rstBut=$("#esp_reset_btn")).hide(),console.log(rstBut),espControllerInit(),await espAlive((function(){devMode=!1})),await getEspVersion(),onEvent("resetting",espIsResetting),devMode&&$("body").append(devModeLabel)}));var loginFormHtml='<div id="auth_con" class="container">\n    <form id="login_form" class="login-box">\n        <h4>Authentication</h4><input id="user_input" class="form-control" type="text" placeholder="Username" /><input id="pass_input" class="form-control" type="password" placeholder="Password" /><button id="login_btn" class="btn btn-primary" type="submit">Login</button><span id="login_msg" style="display: none;">Incorrect Password!</span>\n    </form>\n</div>';class Authenticator{static authenticated=!1;static formHtml='<div id="auth_con" class="container">\n    <form id="login_form" class="login-box">\n        <h4>Authentication</h4><input id="user_input" class="form-control" type="text" placeholder="Username" /><input id="pass_input" class="form-control" type="password" placeholder="Password" /><button id="login_btn" class="btn btn-primary" type="submit">Login</button><span id="login_msg" style="display: none;">Incorrect Password!</span>\n    </form>\n</div>';static Start(e,t){console.log("Authenticating...");var n=devMode?null==t?Authenticator.Success:t:null==t?Authenticator.Failed:t;$.ajax({type:"GET",url:"/auth",data:null,success:null==e?Authenticator.Success:e,error:n,async:!1})}static Logout(){console.log("Logging out..."),$.ajax({type:"POST",url:"/logout",data:null,success:refreshPage,error:function(e,t,n){console.log("Logout Failed")}})}static Is(){return Authenticator.authenticated}static Success(){Authenticator.authenticated=!0,Show($("main")),$("#auth_con").remove(),console.log("Authorization Successful"),invokeEvent("auth"),$("html").attr("auth",""),$("#logout_but").click(Authenticator.Logout)}static Failed(){console.log("Authorization Failed"),$("main").remove(),0==$("#auth_con").length&&$("#nav_head").after(Authenticator.formHtml),Authenticator.AttachFormEvent(),Show($("#auth_con"))}static AttachFormEvent(){$("#login_form").submit((function(e){e.preventDefault(),console.log("Login Form Submit");var t={};t.username=strToByteArray(encryptXOR($("#user_input").val(),170)),t.password=strToByteArray(encryptXOR($("#pass_input").val(),170)),console.log(t.username),console.log(t.password);var n=JSON.stringify(t);printBits(n),console.log(n),$.ajax({url:"/auth",type:"POST",data:n,username:t.username,password:t.password,success:function(){console.log("Authentication Successful"),refreshPage()},error:function(e,t,n){console.log("Invalid username or password"),$("#login_msg").text("Invalid Username or Password"),Show($("#login_msg"))}})}))}}function dec2bin(e){return(e>>>0).toString(2)}function strToByteArray(e){for(var t=[e.length],n=0;n<e.length;n++)t[n]=e[n].charCodeAt(0);return t}function printBits(e){console.log("print bits "+e);for(var t=0;t<e.length;t++)console.log(e[t]+" : "+e[t].charCodeAt(0)+" : 0x"+e[t].charCodeAt(0).toString(16)+" : "+dec2bin(e[t].charCodeAt(0)>>>0).toString(2))}function encryptXOR(e,t){for(var n="",i=isNaN(t)?t.charCodeAt(0):t,o=0;o<e.length;o++){var a=e.charCodeAt(o)^i;n+=String.fromCharCode(a)}return n}function globalStatusInit(){console.log("globalStatusInit()"),navWebUpdate=$("#nav_webupdate"),devMode?loadDummyGlobalStatus():requestJsonData("/status",receivedGlobalStatus,retryGetGlobalStatus,null,5e3)}function receivedGlobalStatus(e){console.log("Received Global Status :"),console.log(e),globalStatusJOBJ=e,configMode=e.status.status.wifi.configMode,populateGlobalStatus(e),invokeEvent("globalStatus"),configMode&&invokeEvent("configMode")}function populateGlobalStatus(e){e.status.status,e.status.retainedStatus;if($("[status-content=global]").length>0){objectToTables($("[status-content=global]"),e,!1)}}function retryGetGlobalStatus(e,t,n){console.log("Could not get Global Status."),$("#global_status").text("Could not get global status")}function loadDummyGlobalStatus(){loadData("/assets/js/dummyStatus.json",(function(e){receivedGlobalStatus(e)}))}onEvent("version",(function(){$(".main-container").hide(),$("#auth_con").hide(),Authenticator.Start()})),EventReady.add((function(){0!=$("[status-content=global]").length&&onEvent("auth",globalStatusInit)}));var updateInProgess=!1;function webupdate_init(){console.log("webupdate_init()"),Show($("#update_con")),$("#update_progress").hide(),$("#debug_output").hide(),$("#file_input").on("change",(function(){webupdate_filechanged($(this))})),$("#update_form").submit((function(e){Authenticator.Start((function(){console.log("Still authenticated.")}),(function(){refreshPage()})),webupdate_submit(),e.preventDefault();var t=$("#update_form")[0],n=new FormData(t);$.ajax({url:"/update/upload",type:"POST",data:n,contentType:!1,processData:!1,xhr:function(){updateInProgess=!0,disableObj($("#esp_reset_button"));var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){var t=(e.loaded/e.total*100).toFixed(2);addToConsole("Progress : "+t),setProgress(t),100==t&&(setUploadMessage("Update Complete! Device is restarting...",!1),setTimeout((function(){invokeEvent("resetting")}),3500))}}),!1),e},success:function(e,t){addToConsole("Success!")},error:function(e,t,n){updateInProgess=!1,enableObj($("#esp_reset_button"))}})}))}function webupdate_submit(){addToConsole("Upload started...");$("#update_button");setUploadBtnState(!1),setUploadMessage("Uploading... Please be patient.",!0),Show($("#update_progress"))}function webupdate_filechanged(e){if(""!=e.val()){var t=e.val().split("\\").pop();if("bin"!=t.split(".").pop())setUploadMessage("Firmware file must be a binary!",!0),e.val(""),setUploadBtnState(!1);else{var n=0;try{var i=/V[0-9]+.[0-9]+.[0-9]+/g.exec(t)[0];if(null!=i)n=compareVersions(versionFromString(i=i.substring(1,i.length)),espVersion)}catch{}setUploadMessage(-1==n?"Current firmware is newer than file. Upload?.":"File OK! Ready to upload.",!1),setUploadBtnState(!0)}}}function setUploadBtnState(e){var t=$("#upload_button");e?(t.removeClass("disabled"),t.removeAttr("disabled")):(t.addClass("disabled"),t.attr("disabled"))}function setUploadMessage(e,t){var n=$("#error_message");t?(n.addClass("error"),n.removeClass("message")):(n.removeClass("error"),n.addClass("message")),n.text(e)}function setProgress(e){Show($("#update_progress")),Show($("#update_progress").children()),$("#update_progress").children().attr("aria-valuenow",e),$("#update_progress").children().width(e+"%"),$("#update_progress").children().text(e+"%")}function addToConsole(e){console.log(e),$("#debug_output").append("<p>"+e+"</p>")}EventReady.Add((function(){0!=$("#update_form").length&&onEvent("auth",webupdate_init)})),Show($("#tool_parent"));class MqttDevice{static eventDeviceInfoCreated=new Set;static deviceInfo;static rootDevInfoKey="mqttDeviceInfo";static activeDevice;static stateStrings={ok:"ok",disabled:"disabled",error:"error",unknown:"unknown",loading:"loading",permanentOff:"permOff"};static deviceInfoProcessed=!1;constructor(e,t,n,i,o,a){if(1!=arguments.length){var l=this;this.index=e,this.name=t,this.device=n,this.deviceName=i,this.type=o,this.state=a,this.enabled=a==MqttDevice.stateStrings.ok,this.url="/mqtt/devices/"+o+"/"+t,this.path="/mqtt/devices/"+o+"/"+n,console.log("MqttDevice() name : "+t+" | device : "+n+" | type : "+o+" | state : "+a+" | url : "+this.url),this.listElem=null,this.ledGroup=null,this.EventRequest=new Set,this.EventRequestComplete=new Set,this.EventRequestSuccess=new Set,this.EventRequestFailed=new Set,this.EventStateChanged=new Set,this.EventStatusChanged=new Set,this.EventConfigChanged=new Set,this.statusUpToDate=!1,this.EventRequest.Add((function(){null!=l.ledGroup&&l.ledGroup.attr("state",MqttDevice.stateStrings.loading)})),this.EventRequestComplete.Add((function(){null!=l.ledGroup&&l.ledGroup.attr("state")==MqttDevice.stateStrings.loading&&l.ledGroup.attr("state","")})),this.EventRequestFailed.Add((function(){null!=l.ledGroup&&l.ledGroup.attr("state",MqttDevice.stateStrings.unknown)})),this.EventRequestSuccess.Add((function(){null!=l.ledGroup&&l.ledGroup.attr("state")==MqttDevice.stateStrings.unknown&&l.ledGroup.attr("state","")})),this.EventStateChanged.Add(this.SetLeds),this.EventStatusChanged.Add(this.SetLeds)}else console.error("Can not assign MqttDevice!")}static GetAllInfo(){if(console.log("MqttDevice.GetAllInfo()"),devMode)MqttDevice.LoadDummyDeviceInfo();else if(MqttDevice.UseLocalInfo()&&localHasObj(MqttDevice.rootDevInfoKey)){MqttDevice.GetLocalInfo();MqttDevice.ProcessAllDeviceInfo()}else requestJsonData("/mqtt/devices/info",(function(e){console.log("Received MQTT Device Info :"),console.log(e),MqttDevice.SetInfo(e),MqttDevice.ProcessAllDeviceInfo()}),MqttDevice.RetryGetAllInfo)}static RetryGetAllInfo(){console.log("MqttDevice.RetryGetAllInfo()");var e="Failed to get MQTT Devices Info.";let t=" Trying again...";configMode?(e="Config Mode Enabled : No MQTT devices are initialized.",t=""):espAlive((function(){setTimeout(MqttDevice.GetAllInfo,5e3)}),(function(t,n,i){console.log(e),$("[mqtt=devicelist] .grid.list").text(e)})),console.log(e+t),$("[mqtt=devicelist] .grid.list").text(e+t)}static LoadDummyDeviceInfo(){console.log("MqttDevice.LoadDummyDeviceInfo()"),loadData("/assets/js/mqtt/dummy-device-list-test.json",(function(e){MqttDevice.SetInfo(e),MqttDevice.ProcessAllDeviceInfo()}))}static SetInfo(e){MqttDevice.deviceInfo=e,localStoreObj(MqttDevice.rootDevInfoKey,MqttDevice.deviceInfo)}static GetLocalInfo(){return MqttDevice.deviceInfo=localReadObj(MqttDevice.rootDevInfoKey)}static SetUseLocalInfo(){localStorage.setItem("useLocalDeviceInfo","true")}static ResetUseLocalInfo(){localStorage.setItem("useLocalDeviceInfo","false")}static UseLocalInfo(){return"true"==localStorage.getItem("useLocalDeviceInfo")}static SetActiveDevice(e,t){console.log("MqttDevice.SetActiveDevice()"),MqttDevice.activeDevice=e,mqttDevices[e.type][e.index]=e,localStoreObj("device",e),t&&MqttDevice.NavigateToActive()}static GetActiveDevLocal(){if(!localHasObj("device"))return null;var e=localReadObj("device");return MqttDevice.activeDevice=MqttDevice.Find(e.name,e.type,!0)}static NavigateToActive(){console.log("MqttDevice.NavigateToActive()"),window.location.href="/mqtt/devices/device.html"}static ProcessAllDeviceInfo(){console.log("MqttDevice.ProcessAllDeviceInfo()"),MqttDevice.AppendRawJsonData(),MqttDevice.ProcessDeviceInfo("sensors"),MqttDevice.ProcessDeviceInfo("binarySensors"),MqttDevice.ProcessDeviceInfo("switches"),MqttDevice.ProcessDeviceInfo("buttons"),MqttDevice.ProcessDeviceInfo("lights"),$("[mqtt=devicelist]").length>0&&(createDeviceList(mqttDevices),$("[action=select-device]").click(MqttDevice.NavigateToActive),initNavToDevBut()),MqttDevice.eventDeviceInfoCreated.Invoke(),MqttDevice.deviceInfoProcessed=!0,MqttDevice.CreateErrorNotifications()}static CreateErrorNotifications(){Object.keys(mqttDevices).forEach((function(e){var t=mqttDevices[e];0!=t.length&&t.forEach((function(e){e.state==MqttDevice.stateStrings.error&&addNotification("fa fa-exclamation","Device "+e.name+" is not working.","red")}))}))}static ProcessDeviceInfo(e){if(console.log("MqttDevice.ProcessInfo()"),MqttDevice.deviceInfo[MqttDevice.rootDevInfoKey][e])for(var t=MqttDevice.deviceInfo[MqttDevice.rootDevInfoKey][e],n=0;n<t.length;n++){var i=t[n];mqttDevices[e].push(new MqttDevice(n,i.name,i.deviceKey,i.deviceName,e,i.state))}}static RefreshActiveStatus(){var e=MqttDevice.activeDevice;null!=e&&e.GetStatus(setMqttDeviceStatus,(function(t,n,i){let o=t.responseText;enableBlockingMsg("Could not refresh "+e.name+"("+e.device+") status\r\n"+o,!0,"red"),$("[status-content=mqttdevice]").text("Get Status Failed...")}))}static AppendRawJsonData(){console.log("MqttDevice.AppendRawJsonData()"),$("#info_devices").length>0&&$("#info_devices").append(syntaxHighlight(JSON.stringify(MqttDevice.deviceInfo,null,4)))}static Find(e,t,n){console.log("findDeviceByName() name : "+e+" | type : "+t);var i=mqttDevices[t];if(null==i)return null;for(var o=0;o<i.length;o++)if(i[o].name==e)return n&&MqttDevice.SetActiveDevice(i[o]),i[o];return null}static CreateLedController(e,t,n){let i=createElement("ledgroup",null,"hover-glow");if(e){let e=createElement("led",null,null,[{key:"state",value:"ok"}],null,null,null,{key:"--led-hue",value:110});i.append(e)}if(t){let e=createElement("led",null,null,[{key:"state",value:"disabled"}],null,null,null,{key:"--led-hue",value:50});i.append(e)}if(n){let e=createElement("led",null,null,[{key:"state",value:"error"}],null,null,null,{key:"--led-hue",value:0});i.append(e)}return i}static EnableAll(e){setAllMqttDevicesEnabled(!0,e)}static DisableAll(e){setAllMqttDevicesEnabled(!1,e)}static SetLedState(e,t,n,i,o){let a=$(t).find("led");a.unbind(),a.removeAttr("on"),a.removeAttr("event"),a.removeAttr("disabled"),a.removeAttr("unknown");let l=$(t).find("led[state="+MqttDevice.stateStrings.ok+"]"),s=$(t).find("led[state="+MqttDevice.stateStrings.disabled+"]"),c=$(t).find("led[state="+MqttDevice.stateStrings.error+"]");switch(e){case MqttDevice.stateStrings.ok:l.attr("on",""),null!=i&&(s.bind("click",i),s.attr("event",""));break;case MqttDevice.stateStrings.error:c.attr("on",""),disableObj(l),disableObj(s),$(t).find("led:not([state=error]").attr("disabled",""),null!=o&&(l.bind("click",o),l.attr("event",""));break;case MqttDevice.stateStrings.disabled:s.attr("on",""),null!=n&&(l.bind("click",n),l.attr("event",""));break;case MqttDevice.stateStrings.permanentOff:disableObj($(t)),null!=n&&(l.bind("click",n),l.attr("event","")),null!=o&&(s.bind("click",o),s.attr("event",""));break;case MqttDevice.stateStrings.unknown:$(t).attr("unknown"),null!=n&&(l.bind("click",n),l.attr("event","")),null!=i&&(s.bind("click",i),s.attr("event",""))}}static GetStateFromId(e){switch(e){case"0":case 0:return MqttDevice.stateStrings.ok;case"1":case 1:return MqttDevice.stateStrings.disabled;case"2":case 2:return MqttDevice.stateStrings.error}return null}static SetAllDeviceLeds(){Object.keys(mqttDevices).forEach((function(e){mqttDevices[e].forEach((function(e){e.SetLeds()}))})),MqttDevice.SetAllLedHeadGroups()}static SetAllLedHeadGroups(){var e={ok:0,disabled:0,total:0};Object.keys(mqttDevices).forEach((function(t){if(0==$("ledgroup[dev-type="+t+"]").length)return;let n=MqttDevice.SetSubTypeLeds(t);if(null!=n)for(let t in e)e[t]+=n[t]}));let t=$("ledgroup[dev-type=all]");MqttDevice.SetLedHeadGroup(t,e)}static SetSubTypeLeds(e){let t=$("ledgroup[dev-type="+e+"]:not([dev-index])");if(0!=t.length)return MqttDevice.SetLedHeadGroup(t,(function(t){return"device-group[dev-type="+e+"] .sub-list led[state="+t+"]"}))}static SetLedHeadGroup(e,t){let n=t;if(t instanceof Function){let e=$(t("ok")+"[on]").length,i=$(t("disabled")+"[on]").length,o=$(t("error")+"[on]").length;n={ok:e,disabled:i,total:$(t("error")).length-o}}var i=e.find("led");removeAttr(i,"on"),removeAttr(i,"event"),i.off();let o=e.find("led[state=disabled]"),a=e.find("led[state=ok]");if(n.ok==n.total&&a.attr("on",""),n.ok!=n.total){a.attr("event","");var l=e.attr("dev-type");a.on("click",(function(){MqttDevice.EnableAll(l)}))}if(n.disabled==n.total&&o.attr("on",""),n.disabled!=n.total){o.attr("event","");l=e.attr("dev-type");o.on("click",(function(){MqttDevice.DisableAll(l)}))}return console.log("tired, reminder to redo"),n}}async function setAllMqttDevicesEnabled(e,t,n){if(null==t||"all"==t){for(var i in mqttDevices)await setAllMqttDevicesEnabled(e,i,!0);MqttDevice.SetAllLedHeadGroups()}else{let i=mqttDevices[t];if(null==i||0==i.length)return console.log("Could not SetEnabled to "+e+" for all "+t+". Device Type does not exist or empty."),!1;for(let t=0;t<i.length;t++){let n=i[t];await n.SetEnabled(e)}n||MqttDevice.SetAllLedHeadGroups()}}MqttDevice.prototype.UrlStatus=function(){return this.url+"/status"},MqttDevice.prototype.UrlState=function(){return this.url+"/state"},MqttDevice.prototype.UrlConfig=function(){return this.url+"/config"},MqttDevice.prototype.UrlSetEnabled=function(){return this.url+"/setEnabled"},MqttDevice.prototype.UrlTopics=function(){return this.url+"/topics"},MqttDevice.prototype.UrlPayload=function(){return this.url+"/payload"},MqttDevice.prototype.IsImportant=function(){if(null!=this.config)return this.config[this.name].deviceConfig.important},MqttDevice.prototype.GetStatus=function(e,t,n){var i=this;this.EventRequest.Invoke(),requestJsonData(this.UrlStatus(),(function(t){i.status=t[i.name],i.state=MqttDevice.GetStateFromId(i.status.deviceStatus.state),i.EventStatusChanged.Invoke(),i.statusUpToDate=!0,null!=e&&e(t),i.EventRequestSuccess.Invoke()}),(function(e,n,o){i.status=void 0,i.statusUpToDate=!1,null!=t&&t(e,n,o),i.EventRequestFailed.Invoke()}),(function(){null!=n&&n(),i.EventRequestComplete.Invoke()}),5e3,!0)},MqttDevice.prototype.GetState=function(e,t,n){var i=this;this.EventRequest.Invoke(),requestJsonData(this.UrlState(),(function(t){i.state=t[i.name].state,i.EventStateChanged.Invoke(),null!=e&&e(t),i.EventRequestSuccess.Invoke()}),(function(e,n,o){i.state=MqttDevice.stateStrings.unknown,null!=t&&t(e,n,o),i.EventRequestFailed.Invoke()}),(function(){null!=n&&n(),i.EventRequestComplete.Invoke()}),5e3,!0)},MqttDevice.prototype.GetConfig=function(e,t,n){var i=this;this.EventRequest.Invoke(),requestJsonData(this.UrlConfig(),(function(t){i.config=t[i.name],i.EventConfigChanged.Invoke(),null!=e&&e(t),i.EventRequestSuccess.Invoke()}),(function(e,n,o){i.config=null,i.EventConfigChanged.Invoke(),null!=t&&t(e,n,o),i.EventRequestFailed.Invoke()}),(function(){null!=n&&n(),i.EventRequestComplete.Invoke()}),5e3,!0)},MqttDevice.prototype.SetConfig=async function(e,t,n){console.warn(this),console.log(e),alert("MqttDevice.prototype.SetConfig"),n()},MqttDevice.prototype.SetEnabled=async function(e,t,n,i){var o=this;e&&o.state!=MqttDevice.stateStrings.disabled||(e||o.state==MqttDevice.stateStrings.ok)&&(devMode?(this.state=e?"ok":"disabled",this.EventStateChanged.Invoke()):(this.EventRequest.Invoke(),$.ajax({type:"POST",url:o.UrlSetEnabled(),data:{enable:e},success:function(t){console.log(o.name+" SetEnabled("+e+") Success"),o.state=t.state,o.statusUpToDate=!1,o.SetLeds(),o.EventStateChanged.Invoke(),o.EventRequestSuccess.Invoke(),MqttDevice.RefreshActiveStatus()},error:function(t,n,i){404!=t.status&&511!=t.status||(console.log(o.name+" SetEnabled("+e+") Error : "+t.responseText),o.state=MqttDevice.stateStrings.unknown,o.statusUpToDate=!1,o.EventRequestFailed.Invoke())},complete:function(){null!=i&&i(),o.EventRequestComplete.Invoke()}},5e3,!0)),this.SetLeds())},MqttDevice.prototype.GetTopics=function(e,t,n){var i=this;this.EventRequest.Invoke(),requestJsonData(this.UrlTopics(),(function(t){i.topics=t[i.name].topics,i.EventStateChanged.Invoke(),null!=e&&e(t),i.EventRequestSuccess.Invoke()}),(function(e,n,o){null!=t&&t(e,n,o),i.EventRequestFailed.Invoke()}),(function(){null!=n&&n(),i.EventRequestComplete.Invoke()}),5e3,!0)},MqttDevice.prototype.GetPayload=function(e,t,n){var i=this;this.EventRequest.Invoke(),requestJsonData(this.UrlPayload(),(function(t){i.payload=t,i.EventStateChanged.Invoke(),null!=e&&e(t),i.EventRequestSuccess.Invoke()}),(function(e,n,o){null!=t&&t(e,n,o),i.EventRequestFailed.Invoke()}),(function(){null!=n&&n(),i.EventRequestComplete.Invoke()}),5e3,!0)},MqttDevice.prototype.SetLeds=function(){function e(e){let t=$(e.target),n=$($(e.target).parent()),i=n.attr("dev-index"),o=n.attr("dev-type");mqttDevices[o][i].SetEnabled(t.attr("state")==MqttDevice.stateStrings.ok)}null!=this.ledGroup&&MqttDevice.SetLedState(this.state,this.ledGroup,e,e),MqttDevice.deviceInfoProcessed&&(MqttDevice.SetSubTypeLeds(this.type),MqttDevice.SetAllLedHeadGroups())},onEvent("auth",(function(){null!=$("[mqtt]")&&(MqttDevice.eventDeviceInfoCreated.add(MqttDevice.GetActiveDevLocal),MqttDevice.GetAllInfo())}));var canSelectDevice=!0,selectedDeviceElem=null,testhtml='<span name>Co2 Sensor</span><span device>SCD4x<br /></span><span status="ok"><br /></span>',navToDevButHtml='<button class="btn btn-primary" type="button" action="select-device" disabled>Navigate to</button>',deviceListElem=$("main [mqtt=devicelist]"),navToDeviceButton=$("main button[action=select-device]"),navToDevVisDetector=$("div.vis-detect[button=select-device]"),clickedDev=!1,navingToDev=!1;function navToDevButClick(){null!=MqttDevice.activeDevice&&MqttDevice.NavigateToActive()}function initNavToDevBut(){console.log("initNavToDevBut"),0!=navToDeviceButton.length&&(null==MqttDevice.activeDevice?(disableObj(navToDeviceButton),navToDeviceButton.text("Select A Device")):(enableObj(navToDeviceButton),navToDeviceButton.text("Navigate to "+MqttDevice.activeDevice.name),$(".grid.device-container[mqttdevice] [name="+MqttDevice.activeDevice.name+"]").parent().attr("selected",""),loadMqttDeviceSummary()),navToDeviceButton.click(MqttDevice.NavigateToActive))}function moveNavToDevButton(e){var t={top:-$("nav").height(),bottom:-$("footer").height()};navToDevVisDetector.isInViewport(t)?navToDeviceButton.hasClass("position-absolute")||navToDeviceButton.addClass("position-absolute"):(navToDeviceButton.removeClass("position-absolute"),navToDeviceButton.css("--device-status-width",deviceListElem.offset().left+20+"px")),deviceListElem.isInViewport()?navToDeviceButton.show():navToDeviceButton.hide()}function createDeviceList(e){console.log("createDeviceList()"),console.log(e);var t=$("[mqtt=devicelist]"),n=t.find(".grid.list");$(t.find(".heading")[0]).after(n);var i=createSublist("Sensors","sensors",e.sensors),o=createSublist("Binary Sensors","binarySensors",e.binarySensors),a=createSublist("Lights","lights",e.lights),l=createSublist("Buttons","buttons",e.buttons),s=createSublist("Switches","switches",e.switches);n.append(i),n.append(o),n.append(a),n.append(l),n.append(s),MqttDevice.SetAllDeviceLeds(),MqttDevice.SetAllLedHeadGroups(),n.keypress((function(e){$(document.activeElement).attr("disabled")||selectMqttDevice(e)})),n.click((async function(e){if(!clickedDev){if(clickedDev=!0,await sleep(300),e.originalEvent.detail>1||navingToDev)return navingToDev=!1,void(clickedDev=!1);navingToDev||selectMqttDevice(e),clickedDev=!1}})),n.dblclick((async function(e){navingToDev=!0,selectMqttDevice(e),MqttDevice.NavigateToActive()}))}function createSublist(e,t,n){console.log("createSublist() "+e);var i=createElement("device-group",null,["device-group"],{key:"dev-type",value:t});let o=createElement("div",null,["grid","head-container"]);var a=createElement("h3",null,null,null,e),l=MqttDevice.CreateLedController(!0,!0),s=createElement("device-list",null,"sub-list");if(l.attr("dev-type",t),o.append(a),o.append(l),i.append(o),i.append(s),null!=n&&0!=n.length){s.prepend(createHeadingForDeviceList());for(var c=0;c<n.length;c++){var r=createDeviceForList(n[c]);s.append(r)}return console.log(i),i}}function createHeadingForDeviceList(e){console.log("createHeadingForDeviceList()");var t=createElement("div",null,["grid","label-container"]),n=createElement("span",null,null,null,"Name"),i=createElement("span",null,null,null,"Device"),o=createElement("span",null,null,null,"Status");return t.append(n),t.append(i),t.append(o),t}function createDeviceForList(e){console.log("createDeviceForList()"),console.log(e);let t=createElement("device-item",null,["grid","device-container"],[{key:"tabindex",value:0},{key:"mqttdevice"},{key:"url",value:e.url}]),n=createElement("span",null,null,{key:"name",value:e.name},e.name),i=createElement("span",null,null,[{key:"device",value:e.device},{key:"type",value:e.type}],e.deviceName),o=MqttDevice.CreateLedController(!0,!0,!0);return e.ledGroup=o,o.attr("dev-index",e.index),o.attr("dev-type",e.type),e.listElem=t,t.attr("dev-index",e.index),t.attr("dev-type",e.type),t.append(n),t.append(i),t.append(o),t}function selectMqttDevice(e){var t="click"==e.type?$(e.target):$(document.activeElement);if(t.is("led"))return null;if(null!=t.attr("disabled"))return null;if(null==t.attr("mqttdevice")){if(null==t.parent().attr("mqttdevice"))return null;t=t.parent()}disableDeviceList(),console.log("selectMqttDevice()"),console.log(t),$("[mqttdevice]").removeAttr("selected"),t.attr("selected",""),selectedDeviceElem=t;let n=t.find("[name]").attr("name"),i=t.find("[type]").attr("type");return null==MqttDevice.Find(n,i,!0)?(selectedDeviceElem=null,console.log("Could not find device! name : "+n+" | type : "+i),navToDeviceButton.text("Error"),ensableDeviceList(),null):(navToDeviceButton.text("Navigate to "+t.find("[name]").attr("name")),loadMqttDeviceSummary(),enableDeviceList(),t)}function loadMqttDeviceSummary(){devMode?loadDummyMqttStatus():(disableDeviceList(),MqttDevice.activeDevice.GetStatus((function(e){enableDeviceList(),setMqttDeviceStatus(e,MqttDevice.activeDevice)}),(function(e,t,n){enableDeviceList();let i=MqttDevice.activeDevice;$("[status-content=mqttdevice]").text("Could not load "+i.name+"("+i.device+") status | "+e.responseText)})))}function disableDeviceList(){disableObj($("section[mqtt=devicelist] *"),!0),disableObj(navToDeviceButton)}function enableDeviceList(){enableObj($("section[mqtt=devicelist] *"),!0),enableObj(navToDeviceButton)}function requestJsonData(e,t,n,i,o,a){return $.ajax({async:null==a||a,dataType:"json",type:"GET",url:e,data:null,success:t,error:n,complete:i,timeout:null==o?3e3:o})}function objectToTables(e,t,n,i){console.log("objectToTables"),console.log(t),$(e).empty();for(let o in t){let a=createStatusTable(o,n?o:null,!0);$(a.find("table")[0]).addClass("table-tree");try{populateStatusTable(a.find("tbody"),t[o],!!i&&n)}catch{console.log("Failed to Populate table "+o)}$(e).append(a)}}function createStatusTable(e,t,n){console.log("createStatusTable : "+e);let i=null;null!=t&&(i=new ElementBuilder("caption"),i.Text(t),null!=n&&i.Classes("caption-top"));let o=new ElementBuilder("div");o.Classes("font-monospace");let a=new ElementBuilder("table");a.Classes(["table","table-sm"]),a.Attrs({key:"status-content",value:e});let l=new ElementBuilder("tbody");var s=o.Create();let c=a.Create(),r=l.Create();return null!=i&&c.append(i.Create()),c.append(r),s.append(c),$(s)}function populateStatusTable(e,t,n){console.log("populateStatusTable"),console.log(t),e.find("tr").remove();for(let i in t){let o,a=t[i],l=getValueTypeClass(a),s=createElement("tr"),c=createElement("td",null,null,null,i);if(a instanceof Object){let e=createStatusTable(i,n?i:null,!0);o=createElement("td"),o.append(e),populateStatusTable(e.find("tbody"),t[i],n)}else getValueTypeClass(a),o=createElement("td",null,l,null,a instanceof String?a:null!=a?a.toString():null);$(s).append(c),$(s).append(o),$(e).append(s)}}function devicePageInit(){"device.html"==getPageName()&&getMqttDeviceData()}function setDeviceInfoElement(e,t,n,i,o,a){var l=$(e).find("["+t+"]");!a&&l.is("span, h1, h2, h3, h4, h5, h6")&&l.text((null!=i?i:"")+n),o||l.attr(t,n)}function setMqttDeviceStatus(e,t){if(0==$("section.device-status").length)return;null==t&&(t=MqttDevice.activeDevice),null==e&&(e=t.status);e[Object.keys(e)[0]];objectToTables($('section.device-status[dev-index=""][dev-type=""] [status-content=mqttdevice], section.device-status[dev-index='+t.index+"][dev-type="+t.type+"] [status-content=mqttdevice]"),e,!1),disableBlockingMsg(),0!=$(".device-config").length&&(MqttDevice.activeDevice.GetConfig((function(e){objectToTables($('section.device-config[dev-index=""][dev-type=""] [config-content=mqttdevice], section.device-config[dev-index='+t.index+"][dev-type="+t.type+"] [config-content=mqttdevice]"),e,!1)}),(function(e,t,n){$("[config-content=mqttdevice]").text("Get Config Failed...")})),MqttDevice.activeDevice.GetTopics((function(e){objectToTables($('section.device-config[dev-index=""][dev-type=""] [topics-content=mqttdevice], section.device-config[dev-index='+t.index+"][dev-type="+t.type+"] [topics-content=mqttdevice]"),e,!1)}),(function(e,t,n){$("[topics-content=mqttdevice]").text("Get Topics Failed...")})),MqttDevice.activeDevice.GetPayload((function(e){objectToTables($('section.device-config[dev-index=""][dev-type=""] [payload-content=mqttdevice], section.device-config[dev-index='+t.index+"][dev-type="+t.type+"] [payload-content=mqttdevice]"),e,!1)}),(function(e,t,n){$("[payload-content=mqttdevice]").text("Get MQTT Payload Failed...")})))}function submitMqttDeviceConfigForm(){if(null!=MqttDevice.activeDevice){setBlockingMsg("Saving "+MqttDevice.activeDevice.name+" Config...",5e3),MqttDevice.activeDevice.SetConfig(null,submitConfigSuccess,submitConfigFailed)}}function submitConfigSuccess(){setBlockingMsg("Save Complete!",3e3)}function submitConfigFailed(e,t,n){setBlockingMsg("Save Failed!",3e3)}function setConfigForm(e){e[Object.keys(e)[0]];let t=$("form[form-action=device-config]");t.load(MqttDevice.activeDevice.url),t.submit(submitMqttDeviceConfigForm)}function loadDummyMqttStatus(){loadData("/assets/js/mqtt/dummy-status-test.json",setMqttDeviceStatus)}function loadDummyMqttConfig(){}function getMqttDeviceData(){enableBlockingMsg("Loading Device Info...");var e=MqttDevice.GetActiveDevLocal();e.ledGroup=$("ledgroup"),e.SetLeds(),e.ledGroup.attr("dev-index",e.index),e.ledGroup.attr("dev-type",e.type),MqttDevice.SetActiveDevice(e);let t=$("[contents=mqttdevice] .device-heading");if(setDeviceInfoElement(t,"name",capitalFirst(e.name)),setDeviceInfoElement(t,"device",e.device.toUpperCase(),"Device : ",!0),setDeviceInfoElement(t,"state",e.state,null,!0),devMode)return loadDummyMqttStatus(),void loadDummyMqttConfig();null!=e?e.GetStatus(setMqttDeviceStatus,(function(t,n,i){let o=t.responseText;enableBlockingMsg("Could not load "+e.name+"("+e.device+") status\r\n"+o,!0,"red"),$("[status-content=mqttdevice]").text("Get Status Failed...")})):window.location.href="/mqtt/devices.html"}onEvent("auth",(function(){})),MqttDevice.eventDeviceInfoCreated.add((function(){devicePageInit()}));var themeSelect,themeSliderHue,themeDefault="Dark",themeDefaultHue=208,themeElements='<div id="theme_container"><select id="theme_select" name="Fixed" value="fixed">\n        <optgroup label="Theme">\n            <option value="dark" selected>Dark</option>\n            <option value="fixed">Dark Fixed</option>\n            <option value="darkspooky">Dark Spooky</option>\n            <option value="darkneon">Dark Neon</option>\n        </optgroup>\n    </select><input id="theme_hue" class="form-range custom" type="range" min="0" max="360" step="1" style="--slider-thumb-hue: 0 !important;" /></div>',themeObj={theme:themeDefault,hue:208};function changeTheme(e){$("html").attr("theme",e),themeObj.theme=e,localStoreObj("theme",themeObj),"darkneon"==e?Show(themeSliderHue):themeSliderHue.hide()}function changeThemeHue(e){themeObj.hue=e,localStoreObj("theme",themeObj),$("html").cssImportant("--theme-hue",e),themeSliderHue.cssImportant("--slider-thumb-hue",e)}function themeHueChanging(){changeThemeHue(themeSliderHue.val())}EventReady.Add((function(){$("nav .gradient").appendTo($("nav")),$("body").append(themeElements),themeSelect=$("#theme_select"),(themeSliderHue=$("#theme_hue")).hide(),localHasObj("theme")?(changeTheme((themeObj=localReadObj("theme")).theme),themeSelect.val(themeObj.theme),themeSliderHue.val(themeObj.hue),changeThemeHue(themeObj.hue)):null!=themeDefault&&(changeTheme(themeDefault),themeSelect.val(themeDefault),themeSliderHue.val(themeDefaultHue),changeThemeHue(themeDefaultHue)),themeSelect.change((function(){changeTheme($(this).val())})),themeSliderHue.mouseenter((function(){EventMouseMove.Add(themeHueChanging)})),themeSliderHue.mouseleave((function(){EventMouseMove.delete(themeHueChanging)}))}));